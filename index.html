import sqlite3
from aiogram import Bot, Dispatcher, executor, types

API_TOKEN = "YOUR_BOT_TOKEN_HERE"  # Replace with your bot token

# Initialize bot
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# -------------------- DATABASE --------------------
def init_db():
    conn = sqlite3.connect("bot.db")
    cur = conn.cursor()
    cur.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        points INTEGER DEFAULT 0
    )
    """)
    conn.commit()
    conn.close()

def add_user(user_id, username):
    conn = sqlite3.connect("bot.db")
    cur = conn.cursor()
    cur.execute("INSERT OR IGNORE INTO users (user_id, username) VALUES (?, ?)", (user_id, username))
    conn.commit()
    conn.close()

def add_points(user_id, amount):
    conn = sqlite3.connect("bot.db")
    cur = conn.cursor()
    cur.execute("UPDATE users SET points = points + ? WHERE user_id = ?", (amount, user_id))
    conn.commit()
    conn.close()

def get_points(user_id):
    conn = sqlite3.connect("bot.db")
    cur = conn.cursor()
    cur.execute("SELECT points FROM users WHERE user_id = ?", (user_id,))
    result = cur.fetchone()
    conn.close()
    return result[0] if result else 0

# -------------------- COMMANDS --------------------
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    add_user(message.from_user.id, message.from_user.username)
    await message.answer(
        "ğŸš€ Welcome to Beta Tester Bot!\n\n"
        "ğŸ¯ Earn points by completing tasks.\n"
        "ğŸ’° Use /tasks to see available tasks.\n"
        "ğŸ“Š Use /balance to check your points."
    )

@dp.message_handler(commands=["balance"])
async def balance(message: types.Message):
    points = get_points(message.from_user.id)
    await message.answer(f"ğŸ’° You currently have **{points} points**!")

@dp.message_handler(commands=["tasks"])
async def tasks(message: types.Message):
    keyboard = types.InlineKeyboardMarkup()
    keyboard.add(types.InlineKeyboardButton("âœ… Join our Channel (+5 pts)", url="https://t.me/YourChannel"))
    keyboard.add(types.InlineKeyboardButton("ğŸŒ Visit Website (+2 pts)", url="https://example.com"))
    await message.answer(
        "ğŸ“‹ Available Tasks:\n\n"
        "1. Join our channel â†’ +5 points\n"
        "2. Visit website â†’ +2 points\n\n"
        "âš¡ Complete and then use /claim to collect points.",
        reply_markup=keyboard
    )

@dp.message_handler(commands=["claim"])
async def claim(message: types.Message):
    # (In real app, youâ€™d verify task. Here we just demo)
    add_points(message.from_user.id, 5)
    points = get_points(message.from_user.id)
    await message.answer(f"ğŸ‰ Task claimed! You now have {points} points.")

# -------------------- MAIN --------------------
if __name__ == "__main__":
    init_db()
    executor.start_polling(dp, skip_updates=True)

